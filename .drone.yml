kind: pipeline
type: docker
name: auto-on-staging

platform:
  os: linux
  arch: arm64
  
trigger:
  branch:
    - staging
  event:
    - push
    
steps:
  - name: install-and-build-staging
    image: node:18-alpine
    commands:
      - echo "ğŸš€ Build automatique sur staging"
      - cd test_drone
      - npm install
      - npm run lint
      - npm run build
      - echo "âœ… Staging build terminÃ©"

---
kind: pipeline
type: docker
name: production-build

platform:
  os: linux
  arch: arm64

trigger:
  branch:
    - main
  event:
    - push

steps:
  - name: install-dependencies
    image: node:18-alpine
    commands:
      - echo "ğŸ“¦ Installation des dÃ©pendances"
      - cd test_drone
      - npm install
      - echo "âœ… DÃ©pendances installÃ©es"

  - name: lint-and-test
    image: node:18-alpine
    commands:
      - echo "ğŸ” VÃ©rification du code"
      - cd test_drone
      - npm install
      - npm run lint
      - echo "âœ… Code vÃ©rifiÃ©"
    depends_on:
      - install-dependencies

  - name: build-production
    image: node:18-alpine
    commands:
      - echo "ğŸ—ï¸ Construction de l'application pour production"
      - cd test_drone
      - npm install
      - npm run build
      - echo "âœ… Build production terminÃ©"
    depends_on:
      - lint-and-test

---
kind: pipeline
type: docker
name: production-deploy

platform:
  os: linux
  arch: arm64

trigger:
  branch:
    - main
  event:
    - promote
  target:
    - production

steps:  
  - name: build-and-push
    image: plugins/docker
    settings:
      registry: docker-registry:5000
      repo: docker-registry:5000/test_drone
      tags: latest
      insecure: true
      context: .
      dockerfile: Dockerfile


